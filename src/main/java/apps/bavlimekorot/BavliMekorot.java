package apps.bavlimekorot;

import jngram.NgramDocument;
import jngram.manipulations.MergeToMaximalNgrams;
import jngram.manipulations.RemoveTagsInContainedNgrams;
import jngram.io.Subject;


public class BavliMekorot {

    public static final int MINIMAL_NGRAM_LENGTH = 3;
    public static final int MAXIMAL_NGRAM_LENGTH = 50;
    private static final int MAXIMAL_HOLE_SIZE = 3;
    private static int QUOTE_PROBABLY_TOO_SHORT_VALUE = 4;
    private static final int NUM_MATCHES_THRESHOLD_FOR_MARGINAL_LENGTH_QUOTES = 4;


    public BavliMekorot() {}

    public static NgramDocument findSubjectMekorot(String text) {
        QUOTE_PROBABLY_TOO_SHORT_VALUE = Math.min(QUOTE_PROBABLY_TOO_SHORT_VALUE, text.split(" ").length - 1);
        NgramDocument doc = new NgramDocument(text, MINIMAL_NGRAM_LENGTH, MAXIMAL_NGRAM_LENGTH);
        primaryManipulations(doc, QUOTE_PROBABLY_TOO_SHORT_VALUE, true);
//        if(doc.getAllNgramsWithTags().isEmpty()) {
//            doc = new NgramDocument(text, MINIMAL_NGRAM_LENGTH, MAXIMAL_NGRAM_LENGTH);
//            primaryManipulations(doc, quoteProbablyNoisyThreshold * 2, false);
//        }
        return doc;
    }

    public static NgramDocument findSubjectMekorot(Subject s) {
        String text = s.getText();
        String uri = s.getUri();
        if (text != null && uri != null) {
            return findSubjectMekorot(text);
        } else {
            System.out.println("Subject " + s.getUri() + " has not text or uri");
            return null;
        }
    }

    public static void main(String args[]) {
        String text = "יוצר אור ואמרו שם דהא דרבי זריקא לאו בפי' איתמר אלא מכללא איתמר דאמר רבי זריקא א''ר אמי אר''ל זאת אומרת ברכות אין מעכבות זו את זו% כלומר אא''ב יוצר אור הוו אמרי היינו דאין מעכבות זו את זו דלא הוו אמרי אהבה רבה אא''א אהבה רבה הוו אמרי דילמא הא דלא אמרי יוצר אור משום דלא מטא זמן יוצר אור וכי מטא זמניה הוו אמרי ליה ואי מכללא מאי כלומר מאי גריעותיה מאילו איתמר בפירוש ומהדר דאי מכללא לעולם אהבה רבה הוו אמרי וכי מטא זמן יוצר אור הוו אמרי ליה ומאי ברכות אין מעכבות זו את זו סדר ברכות. משמע מהכא דכיון דקי''ל דברכות אין מעכבות זו את זו מכ''ש שאין סדר לברכות ומ''מ יש לתמוה דכיון דקי''ל כל ברכה שאין בה שם ומלכות אינה ברכה וברכה הסמוכה לחבירתה אין בפתיחתה הזכרת השם ובכולה ליכא מלכות כשקורא אותה בלא סמוכה לחבירתה היאך יצא וצריך לומר דכיון שהיא סמוכה לחבירתה שיש בה שם ומלכות כשקורא אותה בפני עצמה נמי חשיבא כאילו יש בה שם ומלכות: בשחרית פתח יוצר אור וכו' עד אחר חתימתן. בסוף פרק קמא דברכות (שם י\\\"ב.) גרסינן %פשיטא היכא דנקיט כסא דחמרא בידיה וקסבר דשיכרא הוא ופתח ומברך אדעתא דשיכרא ומסיים אדעתא דחמרא יצא דאי נמי סיים בדשיכרא יצא דהא תנן על כולם אם אמר שהכל נהיה בדברו יצא אלא היכא דנקיט כסא דשיכרא בידיה וקסבר דחמרא הוא פתח ובריך אדעתא דחמרא וסיים בדשיכרא מאי בתר עיקר ברכה אזלינן או בתר חתימה אזלינן ת''ש שחרית פתח ביוצר אור וסיים במעריב ערבים לא יצא פתח במעריב ערבים וסיים ביוצר אור יצא ערבית פתח במעריב ערבים וסיים ביוצר אור לא יצא פתח ביוצר אור וסיים במעריב ערבים יצא כללו של דבר הכל הולך אחר החיתום שאני התם דקאמר ברוך יוצר המאורות. הניחא לרב דאמר כל ברכה שאין בה הזכרת השם אינה ברכה שפיר אלא לרבי יוחנן דאמר כל ברכה שאין בה מלכות אינה ברכה מאי איכא למימר אלא כיון דאמר רבה בר עולא כדי להזכיר מדת יום בלילה ומדת לילה ביום כי קאמר ברכה ומלכות מעיקרא אתרוייהו קאמר% עכ''ל הגמרא. ורבינו כתב בפ''ח מהלכות ברכות לקח כוס של שכר בידו והתחיל הברכה על מנת לומר שהכל וטעה ואמר בורא פרי הגפן אין מחזירין אותו וכן אם היה לפניו תבשיל של דגן ופתח על מנת לומר בורא מיני מזונות וטעה ואמר המוציא יצא מפני שבשעה שהזכיר שם ומלכות שהם עיקר הברכה לא נתכוון אלא לברכה הראויה לאותו המין והואיל ולא היה בעיקר הברכה טעות אע''פ שטעה בסופה יצא ואין מחזירין אותו עכ''ל. וכתבו תלמידי ה''ר יונה שרבינו מפרש פתח בדשיכרא וסיים בדחמרא ר''ל שגמר כל הברכה כמו אם היה שכר ואח''כ סיים ואמר בפה''ג קודם שישתה כגון שאמר בא''י אמ''ה שהכל נהיה בדברו ובורא פרי הגפן יצא כיון שסיים כראוי ואפילו סיים בדשיכרא כלומר ששתה מיד אחר שאמר שהנ''ב ונמצא שהיה הסיום כמו בשכר יצא אלא היכא דנקיט כסא דשיכרא וקסבר דחמרא פתח בדחמרא וסיים בדשיכרא כגון שאמר בא''י אמ''ה בפה''ג ושהנ''ב מאי בתר פתיחה אזלינן כלומר אחר מה שאמר בתחלה בורא פרי הגפן ולא יצא או אחר מה שאמר בסוף שהנ''ב ויצא ולא איפשטא ולקולא ואידך ברייתא בשחרית פתח ביוצר אור מפרש אותה שהתחיל בא''י יוצר אור ובשעת החתימה במקום בא''י יוצר המאורות חתם בא''י המעריב ערבים וכן כולה על זה הדרך. ויש קושיא לדרך הזה דבגמרא חזינן דמדמי הני ברייתות אהדדי ולזה הפירוש אינן דומות דחיתום האמור כאן הו''ל חיתום מדבר אחד בלבד או מיוצר המאורות או ממעריב ערבים וחיתום האמור למעלה הוא שבסוף אמר מענין אחר ובאותה חתימה עצמה אמר מתחילה מענין אחר ונמצא שבין בא''י ובין החתימה עצמה מפסיק עכ''ל. וכיוצא בזה פי' ה''ר מנוח שכתב וז''ל פתח ביוצר אור כגון שאמר בא''י יוצר אור אשר בדברו מעריב ערבים וכו' עד שחתם המעריב ערבים לא יצא שהרי החיתום היה שלא כראוי פתח במעריב ערבים כגון שאמר בא''י אמ''ה אשר בדברו מעריב ערבים יוצר אור ובורא חשך וכו' עד בא''י יוצר המאורות יצא שהרי חתם כהלכתו וכן בערבית וכו' מתפרש על זה הדרך שכל הברכות הולכות אחר חתימתן וכיון שחתם כהוגן אע''פ שפתח שלא כהוגן יצא עכ''ל. ותמהני איך עלה בדעתו לפרש כן בדברי רבינו שהרי דבר מבואר הוא שלשון רבינו אינו סובל פירוש זה בשום פנים שרבינו תלה הדבר שבשעה שזכר שם ומלכות לא נתכוון אלא לברכה הראויה. ולפי דעתם כיון שסיים בברכה הראויה אע''פ שפתח בברכה שאינה ראויה יצא אף ע''פ שמסתמא בשעת הזכרת שם ומלכות היתה כוונתו לברכה שאינה ראויה כמו שפתח וזה היפך דברי רבינו. ולי נראה שרבינו מפרש פתח ומברך אדעתא דשיכרא כלומר בשעת הזכרת שם ומלכות הוה אדעתא דשיכרא ואח''כ נזכר שהוא יין וסיים בפה''ג פשיטא דיצא דהא אפילו סיים כל הברכה כדעת פתיחתה ואמר שהכל יצא אלא כי קא מיבעיא לן פתח אדעתא דחמרא כלומר בשעת הזכרת שם ומלכות הוה אדעתא דחמרא ואחר כך נזכר שהוא שכר ובירך שהכל נהיה בדברו מאי בתר עיקר ברכה דהיינו שם ומלכות אזלינן והוי כאילו סיים ביין ואין ברכת היין פוטרת את השכר או דילמא בתר חתימה אזלינן ויצא ת''ש שחרית פתח ביוצר אור כלומר בשעת הזכרת שם ומלכות הוה אדעתא דליברך יוצר אור ואח''כ שכח ובמקום יוצר אור אמר אשר בדברו מעריב ערבים לא יצא פתח בשעת הזכרת שם ומלכות אדעתא למימר מעריב ערבים ואח''כ נזכר וסיים יוצר אור יצא ערבית פתח אשר בדברו אדעתא למימר מעריב ערבים ואח''כ שכח וסיים יוצר אור לא יצא פתח בשעת הזכרת שם ומלכות אדעתא למימר יוצר אור ואח''כ נזכר וסיים אשר בדברו מעריב ערבים יצא הא קמן דלא אזלינן בתר עיקר ברכה אלא בתר סיומא והא מיפשטא בעיין דבתר סיומא אזלינן ויצא. ודחי לעולם אימא לך דלא יצא דבתר עיקר ברכה אזלינן ותדע מ''ט כי פתח שחרית בעת הזכרת שם ומלכות אדעתא דמעריב ערבים ואח''כ נזכר וסיים יוצר אור יצא משום דמסתמא סירכיה בתרא נקט ואזיל וחתם יוצר המאורות והו''ל לר''י אליבא דרבה בר עולא פותח וחותם ביוצר וכן כי אמרינן ערבית פתח בשעת הזכרת שם ומלכות אדעתא דמעריב ערבים ואח''כ שכח וסיים יוצר אור לא יצא משום דמסתמא סירכיה בתרא נקט וחתם יוצר המאורות וה''ה נמי דכי קאמר שחרית פתח בשעת הזכרת שם ומלכות אדעתא דיוצר אור ואחר כך שכח וסיים אשר בדברו מעריב ערבים היינו טעמא דלא יצא משום דמסתמא סירכיה בתרא נקט וחתם בא''י המעריב ערבים. וכן כי קאמר ערבית פתח בשעת הזכרת שם ומלכות אדעתא דיוצר אור ואח''כ נזכר וסיים אשר בדברו מעריב ערבים היינו טעמא דיצא משום דמסתמא סירכיה בתרא נקט וחתם בא''י המעריב ערבים. וה''מ למימר שאני התם דקאמר בא''י המעריב ערבים אלא נקט בבא קמייתא דקתני בה יצא דהיינו שחרית פתח במעריב ערבים וסיים ביוצר אור יצא ותדע למה יצא לאו משום דבתר סיומא אזלינן דלעולם בתר עיקר ברכה אזלינן אלא היינו טעמא לפי שחתם יוצר המאורות אבל גבי בעיין דליכא תו חתימה ודאי בתר עיקר ברכה אזלינן דטעמא דמסתבר הוא החילוק הזה שאמרו שאני התם דאמר יוצר המאורות ומשום הכי יצא ולפיכך העתיק כאן לשון הברייתא. ומ''ש שכל הברכות הולכות אחר חתימתן ה''ק שכל ברכות שהן כגון אלו שיש חתימה בסופן ואע''פ שאין בסופן מלכות כיון שהפתיחה מעין החתימה כי קאמר ברכה ומלכות מעיקרא אתרוייהו קאמר אבל שאר ברכות שאין בהם שני תנאים אלו בתר עיקר ברכה אזלינן ואמרינן בגמרא דהאי שכל הברכות הולכות אחר החיתום אתא לאתויי אכל תמרי וקסבר נהמא אכל דאע''ג דפתח בעת הזכרת שם ומלכות אדעתא דנהמא וסיים בתמרי יצא מ''ט תמרי נמי מיזן זייני. ורבינו בפ''ח מהלכות ברכות כתב שאם לקח כוס של שכר בידו ונתכוון בשם ומלכות לברך שהכל וטעה ואמר בורא פרי הגפן יצא וממילא נפיק מאי דאיבעיא לן בגמרא כי נקיט כסא דשיכרא ופתח בדחמרא וסיים בדשיכרא שכיון שטעה בעיקר הברכה שלא יצא. ולכן כתב רבינו חלוקה זו ולא כתב חלוקה הנזכרת בגמרא זה נ''ל דרך נכון לדעת רבינו. וכבר עלה בדעתי לפרש דלרבינו ברייתא דפתח ביוצר אור וכו' היינו שהתחיל ממש יוצר אור וחתם בא''י המעריב ערבים ומייתי דאפילו הזכיר הטעות בפיו בתר חתימה אזלינן כל שכן גבי בעיין שלא הזכיר הטעות בפיו אלא בכוונה דלא אזלינן בתר עיקר ברכה ודחי דשאני התם שחותם בסוף יוצר המאורות או מעריב ערבים ומשום הכי יצא ולא אזלינן בתר עיקר ברכה כיון דאיכא חתימה בברכה כראוי אבל גבי בעיין דליכא חתימה בסוף לעולם בתר עיקר ברכה אזלינן ודחיתיו מלשון הברייתא פתח במעריב ערבים וסיים ביוצר אור יצא ואם איתא וסיים ביוצר המאורות מיבעי ליה ומ''מ דרך אפשר הוא ונימא דיוצר אור לאו דוקא. ומדקדוק דברי רבינו נראה שכך היה גורס פשיטא נקט כסא דחמרא בידיה פתח ובריך אדעתא דחמרא וסיים בדשיכרא יצא דא''נ פתח בדשיכרא יצא אלא נקיט כסא דשיכרא בידיה פתח ובריך אדעתא דשיכרא וסיים בדחמרא מאי ואע''פ שאין זה מעלה ומוריד לענין הבנת דברי רבינו כתבתיו לשלמות המלאכה: ודע שעל מה שכתב רבינו פרק ח' מהלכות ברכות כתב הראב''ד ז''ל כל מה שכתב באלו הענינים הכל הבל שאין הולכים אלא על הפירוש שהוציא בפיו עכ''ל. דעתו ז''ל שאין הברכה תלויה בכוונה אלא הכל תלוי במה שמוציא מפיו וכמבואר בפסקי הרא''ש ז''ל והסוגיא יפרשנה כשיטת הרי''ף ז''ל דהיינו אי אזלינן בתר מה שהוציא תחילה בפיו או אחר מה שהוציא בסוף אבל אם נלך אחר כוונת לבו או אחר מה שהוציא בפיו בהא לא אסתפק להו דפשיטא דדברים שבלב אינן דברים ולשון ההשגה הכי דייק שכתב שאין הולכים אלא על הפירוש שהוציא בפיו. ובעל מ''ע שרצה להכריע סברת רבינו מדמקשה תלמודא בפשיטות הניחא למ''ד וכו' אינו הכרע דלפום דדחי ליה שאני התם דקאמר יוצר המאורות א''ל תינח האי דיחויא לרב אלא לר''י מאי איכא למימר אבל טעם רבינו למפסק דבתר עיקר ברכה אזלינן אפילו לקולא כבר כתבתי דהיינו משום דמסתבר טעמא דההוא שינויא דאמרו שאני התם דקאמר יוצר המאורות: וראיתי שאלה אחת ששאלו חכמי לוני''ל לרבינו על זה הלשון והיא בעיני קשה עד מאד וז''ל השאלה. יורנו רבינו ואם שכר שעורים איך יצא ומרנא ורבנא אלפס ז''ל הולך על זה הדרך וחתרנו להוציא להיבשה ולא יכלנו שהרי פירות השכר אינן יוצאים מהגפן ודמי לפתח במעריב ערבים וסיים ביוצר אור לא יצא הראנו אתה רבינו את האור כי טוב: תשובה יראה לי שאין הדברים אמורים אלא בשכר היוצא מן הגפן כמו בנזיר מיין ושכר יזיר ובאותו שכר של ענבים שאין אדם רואה בכוס אם שכר אם יין ושיבא אדם לטעות ויפתח ע''מ שהוא שכר ויסיים בפה''ג אבל בשכר של שעורים וכיוצא בו לא איירי רבנן בדבר זה כלל וכי יש מי שיאמר לקח תמרא ופתח על דעת לברך ב''פ העץ וסיים המוציא לחם מן הארץ יצא אטו בשופטני עסקינן ומה מקום לשגגה זו אלא בשכר היוצא מן הגפן הן הדברים אמורים עכ''ל. וקשה שאיך אמרו שהרי''ף הולך על זה הדרך שאם נתכוונו על שפירש שכר זה היינו שכר של שעורים זאת לא ראינו ולא שמענו מדבריו ואם נתכוונו על שהרי''ף פסק לקולא ואין מחזירין אותו ובחלוקה זו שכתב רבינו יצא הושוו. דבה''ג שכתב רבינו מי הגיד להם שהרי''ף סובר כמותו דילמא לעולם אימא לך שלא יצא לדעת הרי''ף דדברים שבלב אינם דברים. ועוד קשה שאמרו שהרי פירות השכר אינן יוצאים מן הגפן ודמי לפתח במעריב ערבים וסיים ביוצר אור לא יצא דלא דמו דשאני התם דקאמר יוצר המאורות. ועוד שנראה מדבריהם דדוקא בשכר היוצא מן הגפן הדברים אמורים משום דכשאומר בפה''ג קושטא קאמר וא''כ אמאי לא איפשיטא בעיין כי היכי דפשיטא לן היכא דנקט כסא דחמרא וכו' משום דעל כולם אם אמר שהכל יצא הא נמי פשיטא משום דאפילו אמר בפה''ג יצא. גם תשובת רבינו אליהם אינה מתיישבת כלל שאם נתכוון להשיב דדוקא בשכר היוצא מן הגפן עסקינן משום דכי אמר נמי בורא פרי הגפן יצא אבל אם היה שכר שעורים לא יצא. וכן נראה מלשון רבינו ירוחם ז''ל שזהו פי' תשובה זו ואם הדבר כן קשה הקושיות שהקשיתי ועוד קשה למה נדחק לומר דלא איירי בשכר שעורים הרי כתב שאם היו לפניו פירות הארץ והתחיל הברכה על מנת לומר בורא פרי האדמה וטעה ואמר בורא פרי העץ אין מחזירין אותו ואם לקח שכר שעורים והתחיל הברכה על מנת לומר שהכל נהיה בדברו וטעה ואמר בורא פרי הגפן הא ודאי שאין מחזירין אותו דמאי שנא הא מהא. ואם כוונת רבינו בתשובתו נתכוון לתת מציאות איך אפשר שיטעה בין שהכל נהיה בדברו לבורא פרי הגפן וכמו שכתב אטו בשופטני עסקינן ולפי שהם שאלוהו ואם שכר שעורים היאך יצא השיבם דאין הדברים אמורים אלא בשכר גפנים אבל בשכר שעורים אין מקום לטעות אבל אם היה אפשר לטעות אה''נ דה''ה ודומה לפירות הארץ שכתב בסמוך. מ''מ יקשה שמה שטענוהו לא הודה להם ומה שהודה להם לא טענוהו שזה דבר עקרי בשאלתם ועל עיקרה הו''ל להשיב ולומר לא כמו שאתם סוברים שאני מפרש ההלכה כדעת הרי''ף כי שטה אחרת יש לי ולבאר להם מאי זה טעם פסק דבתר עיקר ברכה אזלינן גם לומר להם דלא דמי לפתח במעריב ערבים וסיים ביוצר אור לא יצא ולהניח המקרה ההוא אי עביד איניש דטעי או לא דאטו בין יום ללילה עביד איניש דטעי וכדתניא פתח ביוצר וכו' בין שכר שעורים ליין לא כ''ש ועוד שכמה יינות יש שהם לבנים או צהובים כשכר שעורים וא''כ אין מקום לתשובה זו: מצאתי להרמ''ך שכתב בדוחק גדול אתי פירוש ההלכה לפסק שלו מ''מ מה שהשיב הוא על זה ומוקי ההלכה בשכר של ענבים אינו כלום עכ''ל: והר''ש ן' וירגה נר''ו כתב וז''ל כדי להבין תשובה זו צ''ל שגירסת הרמב''ם בהלכה היא פשיטא היכא דנקט כסא דחמרא בידיה וידע דחמרא הוא ופתח אדעתא דחמרא וסיים בדשיכרא יצא דתנן על הכל אם אמר שהנ''ב יצא אלא היכא דנקיט כסא דשיכרא בידיה וידע דשיכרא הוא ופתח בדשיכרא וסיים בדחמרא מאי בתר ברכה אזלינן או בתר חיתום ועל זה שאלו חכמי לוני''ל להרמב''ם יען היתה זאת גירסתם בספרים שאלו ממנו אם השכר הוא של שעורים איך יעלה על הדעת שיצא בברכת בורא פרי הגפן ועל זה אמרו שחתרו למצוא דרך ליישב דברים אלו של הרי''ף ולא מצאו שהרי זה דומה לפתח בערבית במעריב ערבים וסיים ביוצר אור שלא יצא וה''נ איך יצא בבורא פה''ג על שכר שעורים. וע''ז השיב הרמב''ם שהשכר הוא של גפן כי אם הוא של שעורים לא יעלה על הדעת וכו'. ולפי גירסא זו שאנו אומרים שהיא גירסת הרמב''ם נמצאת החלוקה שהביא הרמב''ם היא החלוקה שעליה נתייסדה בעיית הגמרא עכ''ל. ודבר קשה הוא לומר שהיה לרבינו גירסא שלא נמצאת בספרים וגם יקשה עליו קושיות שהקשיתי לעיל ולכן אני אומר כי השאלה הזו גם תשובתה דבריהם סתומים וחתומים מ''מ לענין דברי רבינו בחיבור נ''ל שמה שכתבתי הוא דבר נכון. וכתבתי כל הדברים האלה במקום הזה לפי שהגמרא הביאה שני הענינים יחד הא דפתח ביוצר אור וכו' והא דפתח בדשיכרא גם אני בעניי ראיתי לכתבם יחד כדי שיתברר הדבר יותר. ובמה שכתב רבינו כאן דשחרית פתח ביוצר אור וכו' למדנו מה פירושו על פי הדרכים שכתבתי למעלה:\",\n" +
                "\"jbo:interprets\": \"jbr:text-mishnetorah-2-1-1-8\",\n" +
                "\n" +
                "\n" +
                "גכע\n";
        findSubjectMekorot(text);
        return;
    }


    public static NgramDocument primaryManipulations(NgramDocument doc, int quoteNoisyThreshold,  boolean removeNonEheviMode) {
        doc.format(new BavliNgramFormatter());
        doc.add(new BavliTagger(MINIMAL_NGRAM_LENGTH));
        doc.add(new EliminateRashiTosafotRashbam());
        doc.add(new MergeToMaximalNgrams());
        doc.add(new FinalMergeTags(MAXIMAL_HOLE_SIZE));
        doc.add(new RemoveTagsInContainedNgrams());
//        if(removeNonEheviMode) {
            // BavliRemoveNonEhevy should be moved here in case the mechanism of removeNonEhevyMode is being uncommented.
//        }
        doc.add(new BavliRemoveNonEhevi());
        doc.add(new RemoveLowLengthMatches(quoteNoisyThreshold));
        doc.add(new RemoveMarginalLengthTagsIfManyMatches(quoteNoisyThreshold * 2, NUM_MATCHES_THRESHOLD_FOR_MARGINAL_LENGTH_QUOTES));
        doc.add(new RemoveMatchBlankMatchTags(MINIMAL_NGRAM_LENGTH));
        return doc;
    }
}
